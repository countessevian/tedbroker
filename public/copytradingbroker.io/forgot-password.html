<!DOCTYPE html>
<html lang="en">

<head>
    <meta name="csrf-token" content="M3XMFmO1P72RsP9UzSPWrMgCcJt9CFMThtEHyGMu">
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1, shrink-to-fit=no" name="viewport">
    <meta name="description" content="TED Brokers - Forgot Password">
    <meta name="author" content="TED Brokers">
    <meta name="keywords" content="TED Brokers - Forgot Password">
    <title>Forgot Password | TED Brokers</title>

    <!-- Favicon -->
    <link rel="icon" href="assets/images/logoIcon/tedbrokers-fav.ico" type="image/x-icon" />

    <!-- Bootstrap css-->
    <link id="style" href="assets/templates/copytradingbroker/auth/main/assets/plugins/bootstrap/css/bootstrap.min.css" rel="stylesheet" />

    <!-- Icons css-->
    <link href="assets/templates/copytradingbroker/auth/main/assets/web-fonts/icons.css" rel="stylesheet" />
    <link href="assets/templates/copytradingbroker/auth/main/assets/web-fonts/font-awesome/font-awesome.min.css" rel="stylesheet">
    <link href="assets/templates/copytradingbroker/auth/main/assets/web-fonts/plugin.css" rel="stylesheet" />

    <!-- Style css-->
    <link href="assets/templates/copytradingbroker/auth/main/assets/css/style.css" rel="stylesheet">
    <link href="assets/templates/copytradingbroker/auth/main/assets/css/plugins.css" rel="stylesheet">
    <script src="assets/templates/copytradingbroker/auth/plugins/sweetalert/js/sweetalert.min.js"></script>
    <script src="assets/templates/copytradingbroker/auth/plugins/sweetalerts/promise-polyfill.js"></script>
    <link href="assets/templates/copytradingbroker/auth/plugins/sweetalerts/sweetalert.css" rel="stylesheet" type="text/css" />
    <script src="../unpkg.com/sweetalert2%407.8.2/dist/sweetalert2.all.js"></script>

    <link rel="stylesheet" href="assets/css/custom-theme.css" />
</head>

<body class="main-body leftmenu ltr light-theme" data-bs-theme="light">
    <style>
        .btn-primary {
            background: #D32F2F;
            color: #fff;
            border: 2px solid #D32F2F;
            font-weight: bold;
            padding: 12px 24px;
            border-radius: 2px;
            transition: all 0.3s ease-in-out;
        }

        .btn-primary:hover {
            background: #FFD700;
            border-color: #FFD700;
            box-shadow: 0 4px 10px rgba(240, 185, 11, 0.3);
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #6c757d;
            color: #fff;
            border: 2px solid #6c757d;
            font-weight: bold;
            padding: 12px 24px;
            border-radius: 2px;
            transition: all 0.3s ease-in-out;
        }

        .btn-secondary:hover {
            background: #5a6268;
            border-color: #5a6268;
        }

        #verification-section {
            display: none;
        }

        .otp-input {
            width: 50px;
            height: 50px;
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            margin: 0 5px;
            border: 2px solid #D32F2F;
            border-radius: 8px;
        }

        .otp-input:focus {
            outline: none;
            border-color: #FFD700;
            box-shadow: 0 0 5px rgba(211, 47, 47, 0.5);
        }
    </style>

    <div class="page main-signin-wrapper">
        <div class="row signpages text-center">
            <div class="col-md-12">
                <div class="card border-0">
                    <div class="row row-sm">
                        <div class="col-lg-6 col-xl-6 col-xs-12 col-sm-12 login_form rounded-start-11">
                            <div class="container-fluid">
                                <div class="row row-sm">
                                    <div class="card-body mt-2 mb-2">
                                        <!-- Email Input Section -->
                                        <div id="email-section">
                                            <h2 class="text-start mb-2">Forgot Password</h2>
                                            <p class="mb-4 text-muted tx-13 ms-0 text-start">
                                                Enter your email address and we'll send you a verification code to reset your password.
                                            </p>

                                            <form id="forgot-password-form">
                                                <div class="form-group text-start">
                                                    <label class="tx-medium">Email Address</label>
                                                    <input class="form-control" id="email" name="email"
                                                        placeholder="Enter your email" type="email" required>
                                                </div>

                                                <button type="submit" class="btn btn-primary btn-block">
                                                    Send Verification Code
                                                </button>
                                            </form>

                                            <div class="text-start mt-4 ms-0">
                                                <a href="login">Back to Login</a>
                                            </div>
                                        </div>

                                        <!-- Verification Code Section -->
                                        <div id="verification-section">
                                            <h2 class="text-start mb-2">Enter Verification Code</h2>
                                            <p class="mb-4 text-muted tx-13 ms-0 text-start">
                                                We've sent a 6-digit code to <strong id="user-email"></strong>
                                            </p>

                                            <form id="verify-code-form">
                                                <div class="form-group text-center mb-4">
                                                    <div class="d-flex justify-content-center">
                                                        <input type="text" class="otp-input" maxlength="1" id="code1" />
                                                        <input type="text" class="otp-input" maxlength="1" id="code2" />
                                                        <input type="text" class="otp-input" maxlength="1" id="code3" />
                                                        <input type="text" class="otp-input" maxlength="1" id="code4" />
                                                        <input type="text" class="otp-input" maxlength="1" id="code5" />
                                                        <input type="text" class="otp-input" maxlength="1" id="code6" />
                                                    </div>
                                                </div>

                                                <button type="submit" class="btn btn-primary btn-block">
                                                    Verify Code
                                                </button>

                                                <button type="button" class="btn btn-secondary btn-block mt-2" id="resend-code-btn">
                                                    Resend Code
                                                </button>
                                            </form>

                                            <div class="text-start mt-4 ms-0">
                                                <a href="#" id="back-to-email">Use different email</a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-6 col-xl-6 d-none d-lg-block text-center bg-primary details rounded-end-11">
                            <div class="mt-5 pt-5 p-2 pos-relative">
                                <div class="clearfix"></div>
                                <h2 class="mt-4 text-white tx-normal">Reset Your Password</h2>
                                <span class="tx-white-6 tx-13 mb-5 mt-xl-0">Don't worry! We will help you to recover
                                    your password</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="gtranslate_wrapper"></div>
        <script>
            window.gtranslateSettings = {
                default_language: "en",
                alt_flags: { "en": "usa" },
                wrapper_selector: ".gtranslate_wrapper",
                flag_style: "3d",
            };
        </script>
        <script src="../cdn.gtranslate.net/widgets/latest/float.js" defer></script>
    </div>

    <!-- Jquery js-->
    <script src="assets/templates/copytradingbroker/auth/main/assets/plugins/jquery/jquery.min.js"></script>

    <!-- Bootstrap js-->
    <script src="assets/templates/copytradingbroker/auth/main/assets/plugins/bootstrap/js/popper.min.js"></script>
    <script src="assets/templates/copytradingbroker/auth/main/assets/plugins/bootstrap/js/bootstrap.min.js"></script>

    <script src="../code.jquery.com/jquery-3.6.0.min.js"></script>

    <script>
        const API_BASE_URL = '/api/auth';
        let userEmail = '';

        // Handle forgot password form submission
        document.getElementById('forgot-password-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const email = document.getElementById('email').value;
            userEmail = email;

            try {
                const response = await fetch(`${API_BASE_URL}/forgot-password`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email }),
                });

                const data = await response.json();

                if (response.ok) {
                    // Show verification section
                    document.getElementById('email-section').style.display = 'none';
                    document.getElementById('verification-section').style.display = 'block';
                    document.getElementById('user-email').textContent = email;

                    Swal.fire({
                        icon: 'success',
                        title: 'Code Sent',
                        text: data.message,
                        confirmButtonColor: '#D32F2F'
                    });

                    // Focus on first OTP input
                    document.getElementById('code1').focus();
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: data.detail || 'Failed to send verification code',
                        confirmButtonColor: '#D32F2F'
                    });
                }
            } catch (error) {
                console.error('Error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'An error occurred. Please try again.',
                    confirmButtonColor: '#D32F2F'
                });
            }
        });

        // OTP input handling
        const otpInputs = document.querySelectorAll('.otp-input');
        otpInputs.forEach((input, index) => {
            input.addEventListener('input', (e) => {
                if (e.target.value.length === 1 && index < otpInputs.length - 1) {
                    otpInputs[index + 1].focus();
                }
            });

            input.addEventListener('keydown', (e) => {
                if (e.key === 'Backspace' && e.target.value === '' && index > 0) {
                    otpInputs[index - 1].focus();
                }
            });

            input.addEventListener('paste', (e) => {
                e.preventDefault();
                const pastedData = e.clipboardData.getData('text').slice(0, 6);
                pastedData.split('').forEach((char, i) => {
                    if (otpInputs[i]) {
                        otpInputs[i].value = char;
                    }
                });
                if (pastedData.length === 6) {
                    otpInputs[5].focus();
                }
            });
        });

        // Handle verification code submission
        document.getElementById('verify-code-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const code = Array.from(otpInputs).map(input => input.value).join('');

            if (code.length !== 6) {
                Swal.fire({
                    icon: 'error',
                    title: 'Invalid Code',
                    text: 'Please enter all 6 digits',
                    confirmButtonColor: '#D32F2F'
                });
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/verify-password-reset-code`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email: userEmail, code }),
                });

                const data = await response.json();

                if (response.ok) {
                    // Store reset token and redirect to reset password page
                    localStorage.setItem('reset_token', data.reset_token);
                    localStorage.setItem('reset_email', userEmail);
                    window.location.href = 'reset-password';
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Invalid Code',
                        text: data.detail || 'The verification code is incorrect or has expired',
                        confirmButtonColor: '#D32F2F'
                    });
                    // Clear OTP inputs
                    otpInputs.forEach(input => input.value = '');
                    otpInputs[0].focus();
                }
            } catch (error) {
                console.error('Error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'An error occurred. Please try again.',
                    confirmButtonColor: '#D32F2F'
                });
            }
        });

        // Handle resend code
        document.getElementById('resend-code-btn').addEventListener('click', async () => {
            try {
                const response = await fetch(`${API_BASE_URL}/forgot-password`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email: userEmail }),
                });

                const data = await response.json();

                if (response.ok) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Code Sent',
                        text: 'A new verification code has been sent to your email',
                        confirmButtonColor: '#D32F2F'
                    });
                    // Clear OTP inputs
                    otpInputs.forEach(input => input.value = '');
                    otpInputs[0].focus();
                }
            } catch (error) {
                console.error('Error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Failed to resend code. Please try again.',
                    confirmButtonColor: '#D32F2F'
                });
            }
        });

        // Handle back to email
        document.getElementById('back-to-email').addEventListener('click', (e) => {
            e.preventDefault();
            document.getElementById('verification-section').style.display = 'none';
            document.getElementById('email-section').style.display = 'block';
            // Clear OTP inputs
            otpInputs.forEach(input => input.value = '');
        });
    </script>

    <!-- Chat Support Widget -->
    <script src="/assets/js/chat-events.js"></script>
    <script src="/assets/js/chat-widget.js"></script>
</body>

</html>
